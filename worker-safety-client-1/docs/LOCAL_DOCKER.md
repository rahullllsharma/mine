# Run WS with docker container

> **Note**
>
> The steps described below are using the terminal and docker cli but you can do
> practically the same using **Docker Dashboard UI**.

## Steps

1. Create the docker image from the dockerfile

```sh
docker build .
```

> **Note**
>
> If you need to troubleshoot the container generated by codefresh, you can skip
> this step and download the image generated by codefresh from Google Cloud
> Registry (GCR). To do that, you need to replace the 1. step by going to either
> codefresh > artifacts > images, select the image you need and copy and paste
> the command to your cli, eg,
>
> `docker pull gcr.io/urbint-1259/worker-safety-client:<TAG>`
>
> This will require you to logging to GCR. If you need to login, follow the
> instructions on
> [this page](https://cloud.google.com/container-registry/docs/advanced-authentication).

2. Create a new container based from the image built

```sh
docker run -d -p 3000:3000 -v $(pwd)/:/app -t <hash/tag from the image built> /bin/sh
```

This will automatically bind port 3000 and a volume with the current dir [^1]

> **Note**
>
> we can create limitations on the container
>
> - `--memory="<memory>"` will cap the memory available
> - `--cpus="<total cpus>"` will cap the total of cpus avaiable
> - `--name <name>` will tag the container name
>
> `docker run -d -p 3000:3000 -v $(pwd)/:/app -it --memory="2g" --cpus="2.0" --name wsc-container-3 wsc`

> **Warning**
>
> if you don't have the docker image hash you can always `docker images | less`
> and check which is the latest build from the previous step.

3. SSH into the running container

```sh
docker exec -it <container hash> /bin/sh
```

and you should be ssh'ing the container ![^2]

### What to do in the container?

#### Run WS client

Besides making sure that chrome/puppeteer are properly working, you may need to
do additional changes:

- _On the server, Apollo doesn't have access to WSS_

  That happens because, inside the container, you cannot call `localhost`
  directly. The WSS host should be resolved to
  `WORKER_SAFETY_SERVICE_URL_GRAPH_QL=http://host.docker.internal:8001` but, on
  the client, that hostname is known. You can either:

  1. Make http://host.docker.internal:8001 in your etc/hosts file
  2. Create a temporarily bypass on the client to `http://localhost:8001`
     instead

- _Some dependencies don't run as expected_

  Don't forget that `node_modules` folder is simply "linked" between the host
  and container, meaning that all dependencies are shared between your machine
  and the container using the later restrictions and architecture, eg, mac m1.

  So beware, if you start installing dependencies from inside the container, it
  could mess your dev.

> **Warning**
>
> If you want to be sure, prepare the container by running `yarn build` before
> building the image, and remove the `-v` flag before building the container;

> **Note**
>
> If that were to happen, just `rm -rf node_modules` to remove any dependency.
> Just remember that since volumes are symlinked, it will affect the container
> as well.

#### Debug jest runner

Inside the `/app` in the container, you can try and check if there is any issue
with jest.

```sh
/app/node_modules/.bin/jest --ci --watchAll=false --maxWorkers=4
```

Don't forget to prepare a custom build image, with the limitations you need in
order to fully test runner inside the container

---

[^1]:
    To grab the image hash, you can use `docker images` or
    `docker images | less` and search for the last image built. We can also
    expand and use tagging or even naming the image to be easier to identify the
    image.

```sh
Projects λ docker images
REPOSITORY                                TAG           IMAGE ID       CREATED        SIZE
<none>                                    <none>        50a3ba7360ee   19 hours ago   2.51GB  <-- This is the one we want
<none>                                    <none>        bbf8897a129e   19 hours ago   2.56GB
```

[^2]:
    To access the container hast/name, just do `docker ps` and it should be
    running

```sh
Projects λ docker ps
CONTAINER ID   IMAGE                            COMMAND                  CREATED        STATUS                      PORTS                              NAMES
d87a5167abdc   50a3ba7360ee                     "docker-entrypoint.s…"   18 hours ago   Exited (255) 14 hours ago   0.0.0.0:3000->3000/tcp             festive_shaw <-- This is the one we want
a6f93355579f   worker-safety-service_alembic    "alembic upgrade head"   47 hours ago   Exited (0) 18 hours ago                                        wss-alembic
```
