{"version":3,"file":"little-state-machine.es.js","sources":["../src/logic/storeFactory.ts","../src/constants.ts","../src/StateMachineContext.tsx","../src/stateMachine.tsx","../src/logic/devTool.ts"],"sourcesContent":["import { STORE_DEFAULT_NAME } from '../constants';\nimport { MiddleWare, GlobalState } from '../types';\n\nfunction StoreFactory() {\n  let storageType: Storage;\n  let state: GlobalState = {};\n  let middleWares: MiddleWare[] = [];\n  let name = STORE_DEFAULT_NAME;\n\n  try {\n    storageType =\n      typeof sessionStorage !== 'undefined'\n        ? window.sessionStorage\n        : ({} as Storage);\n  } catch {\n    storageType = {} as Storage;\n  }\n\n  return {\n    updateStore(defaultValues: GlobalState) {\n      try {\n        state = JSON.parse(storageType.getItem(name) || '') || defaultValues;\n      } catch {\n        state = defaultValues;\n      }\n    },\n    saveStore() {\n      storageType.setItem(name, JSON.stringify(state));\n    },\n    get middleWares() {\n      return middleWares;\n    },\n    set middleWares(wares: MiddleWare[]) {\n      middleWares = wares;\n    },\n    get state() {\n      return state;\n    },\n    set state(value) {\n      state = value;\n    },\n    get name() {\n      return name;\n    },\n    set name(value) {\n      name = value;\n    },\n    get storageType() {\n      return storageType;\n    },\n    set storageType(value) {\n      storageType = value;\n    },\n  };\n}\n\nexport default StoreFactory();\n","export const STORE_DEFAULT_NAME = '__LSM__';\nexport const STORE_ACTION_NAME = '__LSM_NAME__';\n","import * as React from 'react';\nimport storeFactory from './logic/storeFactory';\nimport { StateMachineContextValue } from './types';\n\nconst StateMachineContext = React.createContext<StateMachineContextValue>(undefined as any);\n\nexport const StateMachineProvider: React.FC = ({ children }) => {\n  const [state, setState] = React.useState(storeFactory.state);\n\n  return (\n    <StateMachineContext.Provider\n      value={{ state, setState }}\n    >\n      { children }\n    </StateMachineContext.Provider>\n  );\n}\n\nexport function useStateMachineContext() {\n  const value = React.useContext<StateMachineContextValue>(StateMachineContext);\n\n  if (process.env.NODE_ENV !== 'production') {\n    if (!value) {\n      console.error(`StateMachine context is undefined, please verify you are calling useStateMachine() as child of a <StateMachineProvider> component.`)\n    }\n  }\n\n  return value;\n}\n","import * as React from 'react';\nimport { useStateMachineContext } from './StateMachineContext';\nimport storeFactory from './logic/storeFactory';\nimport { setUpDevTools } from './logic/devTool';\nimport {\n  StateMachineOptions,\n  GlobalState,\n  AnyCallback,\n  AnyActions,\n  ActionsOutput,\n  PersistOptions,\n} from './types';\nimport { STORE_ACTION_NAME } from './constants';\n\nlet persistOption: PersistOptions = 'onAction';\n\nexport function createStore(\n  defaultState: GlobalState,\n  options: StateMachineOptions,\n) {\n  if (options) {\n    options.name && (storeFactory.name = options.name);\n    options.storageType && (storeFactory.storageType = options.storageType);\n    options.middleWares && (storeFactory.middleWares = options.middleWares);\n    options.persist && (persistOption = options.persist);\n  }\n\n  if (process.env.NODE_ENV !== 'production') {\n    setUpDevTools(\n      storeFactory.storageType,\n      storeFactory.name,\n      storeFactory.state,\n    );\n  }\n\n  storeFactory.updateStore(defaultState);\n}\n\nconst actionTemplate = <TCallback extends AnyCallback>(\n  setState: React.Dispatch<React.SetStateAction<GlobalState>>,\n  callback: TCallback,\n) => (payload: Parameters<TCallback>[1]) => {\n  if (process.env.NODE_ENV !== 'production') {\n    window[STORE_ACTION_NAME] = callback.name;\n  }\n\n  storeFactory.state = callback(storeFactory.state, payload);\n\n  if (storeFactory.middleWares) {\n    storeFactory.state = storeFactory.middleWares.reduce(\n      (currentValue, currentFunction) =>\n        currentFunction(currentValue, callback.name, payload) || currentValue,\n      storeFactory.state,\n    );\n  }\n\n  setState(storeFactory.state);\n  persistOption === 'onAction' && storeFactory.saveStore();\n};\n\nexport function useStateMachine<\n  TCallback extends AnyCallback,\n  TActions extends AnyActions<TCallback>\n>(\n  actions?: TActions,\n): {\n  actions: ActionsOutput<TCallback, TActions>;\n  state: GlobalState;\n} {\n  const { state, setState } = useStateMachineContext();\n  const actionsRef = React.useRef(\n    Object.entries(actions || {}).reduce(\n      (previous, [key, callback]) =>\n        Object.assign({}, previous, {\n          [key]: actionTemplate(setState, callback),\n        }),\n      {} as ActionsOutput<TCallback, TActions>,\n    ),\n  );\n\n  React.useEffect(() => {\n    if (persistOption === 'beforeUnload') {\n      window.onbeforeunload = () => storeFactory.saveStore();\n    }\n  }, []);\n\n  return {\n    actions: actionsRef.current,\n    state,\n  };\n}\n","import { GlobalState } from \"../types\";\n\nexport function setUpDevTools(\n  storageType: Storage,\n  name: string,\n  state: GlobalState,\n) {\n  if (typeof window === 'undefined') return;\n\n  window.__LSM__ = name;\n\n  window.__LSM_NAME__ = name;\n\n  window.__LSM_DEBUG__ = (value: string) =>\n    storageType.setItem('___LSM_DEBUG__', value);\n\n  window.__LSM_RESET__ = () => storageType.removeItem(name);\n\n  window.__LSM_GET_STORE__ = () => storageType.getItem(name);\n\n  window.__LSM_SAVE_TO__ = (name: any) =>\n    window.localStorage.setItem(name, JSON.stringify(state));\n\n  window.__LSM_LOAD__ = ({\n    storeName,\n    data,\n  }: {\n    storeName: string;\n    data?: string;\n  }) =>\n    storageType.setItem(\n      name || '___LSM_DEBUG__',\n      data || window.localStorage.getItem(storeName) || '',\n    );\n}\n"],"names":["storageType","state","middleWares","name","sessionStorage","window","updateStore","defaultValues","JSON","parse","getItem","saveStore","setItem","stringify","wares","value","StoreFactory","StateMachineContext","React","undefined","StateMachineProvider","children","storeFactory","Provider","setState","persistOption","createStore","defaultState","options","persist","process","env","NODE_ENV","__LSM__","__LSM_NAME__","__LSM_DEBUG__","__LSM_RESET__","removeItem","__LSM_GET_STORE__","__LSM_SAVE_TO__","localStorage","__LSM_LOAD__","data","storeName","useStateMachine","actions","console","error","actionsRef","Object","entries","reduce","previous","assign","callback","payload","currentValue","currentFunction","actionTemplate","onbeforeunload","current"],"mappings":"kHAwDA,MArDA,WACE,IAAIA,EACAC,EAAqB,GACrBC,EAA4B,GAC5BC,ECP4B,UDShC,IACEH,EAC4B,oBAAnBI,eACHC,OAAOD,eACN,GACP,SACAJ,EAAc,GAGhB,MAAO,CACLM,qBAAYC,GACV,IACEN,EAAQO,KAAKC,MAAMT,EAAYU,QAAQP,IAAS,KAAOI,EACvD,SACAN,EAAQM,IAGZI,qBACEX,EAAYY,QAAQT,EAAMK,KAAKK,UAAUZ,KAE3CC,kBACE,OAAOA,GAETA,gBAAgBY,GACdZ,EAAcY,GAEhBb,YACE,OAAOA,GAETA,UAAUc,GACRd,EAAQc,GAEVZ,WACE,OAAOA,GAETA,SAASY,GACPZ,EAAOY,GAETf,kBACE,OAAOA,GAETA,gBAAgBe,GACdf,EAAce,IAKLC,GEpDTC,EAAsBC,OAA8CC,GAE7DC,EAAiC,gBAAGC,IAAAA,WACrBH,EAAeI,EAAarB,OAEtD,OACEiB,EAACD,EAAoBM,UACnBR,MAAO,CAAEd,WAAOuB,gBAEdH,ICCJI,EAAgC,WAEpC,SAAgBC,EACdC,EACAC,OCfA5B,EACAG,EACAF,EDeI2B,IACFA,EAAQzB,OAASmB,EAAanB,KAAOyB,EAAQzB,MAC7CyB,EAAQ5B,cAAgBsB,EAAatB,YAAc4B,EAAQ5B,aAC3D4B,EAAQ1B,cAAgBoB,EAAapB,YAAc0B,EAAQ1B,aAC3D0B,EAAQC,UAAYJ,EAAgBG,EAAQC,UAGjB,eAAzBC,QAAQC,IAAIC,WCxBhBhC,ED0BIsB,EAAatB,YCzBjBG,ED0BImB,EAAanB,KCzBjBF,ED0BIqB,EAAarB,MCxBK,oBAAXI,SAEXA,OAAO4B,QAAU9B,EAEjBE,OAAO6B,aAAe/B,EAEtBE,OAAO8B,cAAgB,SAACpB,UACtBf,EAAYY,QAAQ,iBAAkBG,IAExCV,OAAO+B,cAAgB,kBAAMpC,EAAYqC,WAAWlC,IAEpDE,OAAOiC,kBAAoB,kBAAMtC,EAAYU,QAAQP,IAErDE,OAAOkC,gBAAkB,SAACpC,UACxBE,OAAOmC,aAAa5B,QAAQT,EAAMK,KAAKK,UAAUZ,KAEnDI,OAAOoC,aAAe,mBAOpBzC,EAAYY,QACVT,GAAQ,mBANVuC,MAOUrC,OAAOmC,aAAa9B,UAR9BiC,YAQoD,ODGtDrB,EAAahB,YAAYqB,YAyBXiB,EAIdC,OD7CM9B,KAAAA,EAAQG,EAA2CD,GAE5B,eAAzBa,QAAQC,IAAIC,WACTjB,GACH+B,QAAQC,6IAILhC,GC0CCd,IAAAA,MAAOuB,IAAAA,SACTwB,EAAa9B,EACjB+B,OAAOC,QAAQL,GAAW,IAAIM,OAC5B,SAACC,kBACCH,OAAOI,OAAO,GAAID,gBAnCH,SACrB5B,EACA8B,mBACIC,GACyB,eAAzBzB,QAAQC,IAAIC,WACd3B,OAAM,aAAsBiD,EAASnD,MAGvCmB,EAAarB,MAAQqD,EAAShC,EAAarB,MAAOsD,GAE9CjC,EAAapB,cACfoB,EAAarB,MAAQqB,EAAapB,YAAYiD,OAC5C,SAACK,EAAcC,UACbA,EAAgBD,EAAcF,EAASnD,KAAMoD,IAAYC,GAC3DlC,EAAarB,QAIjBuB,EAASF,EAAarB,OACJ,aAAlBwB,GAAgCH,EAAaX,aAiB9B+C,CAAelC,aAE1B,KAUJ,OANAN,EAAgB,WACQ,iBAAlBO,IACFpB,OAAOsD,eAAiB,kBAAMrC,EAAaX,eAE5C,IAEI,CACLkC,QAASG,EAAWY,QACpB3D,MAAAA"}